project: hakunamatata
configVersion: 1

---
image: promo
from: php:8.1.6-cli-alpine3.16
docker:
  USER: root
  WORKDIR: /var/www
  EXPOSE: "9000"
  CMD: ["sleep", "infinity"]
shell:
  beforeInstall: |
    # install packages for php-cli
    apk add --no-cache libc-dev autoconf make gcc g++ bash vim zip libzip-dev libpng-dev jpeg-dev \
    openssh git colordiff npm inotify-tools
    # install php config
    cp /usr/local/etc/php/php.ini-production /usr/local/etc/php/php.ini
    # ssh_config for gitlab
    printf "Host gitlab-prod.gitlab-prod\n\tStrictHostKeyChecking no\n\tUserKnownHostsFile=/dev/null\n" >> /etc/ssh/ssh_config
    # install jekyll
    apk --no-cache add zlib-dev
    apk --no-cache add libffi-dev
    apk --no-cache add build-base
    apk --no-cache add libxml2-dev
    apk --no-cache add imagemagick-dev
    apk --no-cache add readline-dev
    apk --no-cache add libxslt-dev
    apk --no-cache add yaml-dev
    apk --no-cache add vips-dev
    apk --no-cache add sqlite-dev
    apk --no-cache add cmake
    apk --no-cache add curl-dev
    apk --no-cache add linux-headers
    apk --no-cache add openjdk8-jre
    apk --no-cache add less
    apk --no-cache add zlib
    apk --no-cache add libxml2
    apk --no-cache add readline
    apk --no-cache add libxslt
    apk --no-cache add libffi
    apk --no-cache add tzdata
    apk --no-cache add shadow
    apk --no-cache add libressl
    apk --no-cache add yarn
    apk --no-cache add libatomic
    apk --no-cache add ncurses-terminfo-base
    apk --no-cache add ncurses-terminfo
    apk --no-cache add ruby
    apk --no-cache add ruby-dev
    apk --no-cache add yaml
    apk --no-cache add ruby-io-console
    apk --no-cache add ruby-bundler
    apk --no-cache add ruby-irb
    apk --no-cache add ruby-json
    apk --no-cache add ruby-rake
    apk --no-cache add ruby-bigdecimal

    # ssh_config for gitlab
    printf "Host gitlab-prod.gitlab-prod\n\tStrictHostKeyChecking no\n\tUserKnownHostsFile=/dev/null\n" >> /etc/ssh/ssh_config

    # jekyll
    echo 'source "https://rubygems.org"' > /root/Gemfile
    echo 'gem "jekyll", "~> 4.2"' >> /root/Gemfile
    echo 'gem "webrick", "~> 1.7"' >> /root/Gemfile
    echo 'gem "jekyll-admin", group: :jekyll_plugins' >> /root/Gemfile
    echo 'gem "jekyll-feed"' >> /root/Gemfile
    echo 'gem "jekyll-sitemap"' >> /root/Gemfile
    echo 'gem "jekyll-email-protect"' >> /root/Gemfile
    echo 'gem "jekyll-github-metadata"' >> /root/Gemfile
    echo 'gem "jekyll-paginate-v2"' >> /root/Gemfile
    echo 'gem "jekyll-scholar"' >> /root/Gemfile
    echo 'gem "jekyll-twitter-plugin"' >> /root/Gemfile
    echo 'gem "jemoji"' >> /root/Gemfile
    echo 'gem "unicode_utils"' >> /root/Gemfile
    echo 'gem "jekyll-seo-tag", "~> 2.0"' >> /root/Gemfile
    echo 'gem "rake", ">= 12.3.1", "< 13.1.0"' >> /root/Gemfile

    cd /root && bundle install

  setup: |
    # install npm packages
    npm install -g commitizen cz-conventional-changelog cz-customizable

    # configure commitizen
    echo '{ "path": "cz-conventional-changelog" }' > /root/.czrc

    # configure ssh
    mkdir -p /root/.ssh
    chmod 700 /root/.ssh
    echo 'Host *' > /root/.ssh/config
    echo '    StrictHostKeyChecking no' >> /root/.ssh/config
    chmod 400 /root/.ssh/config
