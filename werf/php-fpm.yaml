image: h-php-fpm
from: php:7.4.14-fpm-alpine3.13
shell:
  beforeInstall:
  - apk add --no-cache libc-dev
  - apk add --no-cache autoconf
  - apk add --no-cache make
  - apk add --no-cache gcc
  - apk add --no-cache g++
  - apk add --no-cache bash
  - apk add --no-cache vim
  - apk add --no-cache zip
  - apk add --no-cache openssl
  - apk add --no-cache openssl-dev
  - apk add --no-cache libzip-dev
  - apk add --no-cache jpeg-dev
  - apk add --no-cache libpng-dev
  - apk add --no-cache openssh
  - apk add --no-cache git
  - apk add --no-cache php7-dev
  - apk add --no-cache colordiff
  - apk add --no-cache npm
  - apk add --no-cache mysql-client
  - docker-php-ext-configure gd --with-jpeg
  - docker-php-ext-install -j$(nproc) gd zip bcmath pcntl pdo_mysql mysqli
  - echo "f***ing pecl must die (operation timed out fixed)"
  - docker-php-source extract
  - git clone --branch 1.5.2 --depth 1 https://github.com/mongodb/mongo-php-driver.git /usr/src/php/ext/mongodb
  - cd /usr/src/php/ext/mongodb && git submodule update --init
  - docker-php-ext-install mongodb
  - echo "install php config"
  - cp /usr/local/etc/php/php.ini-production /usr/local/etc/php/php.ini
  - echo "ssh_config for gitlab"
  - printf "Host gitlab-prod.gitlab-prod.svc.cluster.local\n\tStrictHostKeyChecking no\n\tUserKnownHostsFile=/dev/null\n" >> /etc/ssh/ssh_config
  - echo "install npm packages"
  - npm install -g commitizen cz-conventional-changelog cz-customizable
  - echo "configure commitizen"
  - php -r 'echo json_encode(["path"=>"cz-conventional-changelog"]);' > /root/.czrc
