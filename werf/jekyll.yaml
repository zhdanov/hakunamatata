image: jekyll
from: php:7.4.13-fpm-alpine3.12
shell:
  beforeInstall: |
    # install packages for php-fpm
    apk add --no-cache libc-dev autoconf make gcc g++ bash vim zip libzip-dev libpng-dev jpeg-dev openssh git colordiff php7-dev npm

    # install php-extentions
    docker-php-ext-configure gd --with-jpeg
    docker-php-ext-install -j$(nproc) gd zip

    # install php config
    cp /usr/local/etc/php/php.ini-production /usr/local/etc/php/php.ini

    # jekyll
    apk --no-cache add zlib-dev
    apk --no-cache add libffi-dev
    apk --no-cache add build-base
    apk --no-cache add libxml2-dev
    apk --no-cache add imagemagick-dev
    apk --no-cache add readline-dev
    apk --no-cache add libxslt-dev
    apk --no-cache add yaml-dev
    apk --no-cache add vips-dev
    apk --no-cache add sqlite-dev
    apk --no-cache add cmake
    apk --no-cache add curl-dev
    apk --no-cache add linux-headers
    apk --no-cache add openjdk8-jre
    apk --no-cache add less
    apk --no-cache add zlib
    apk --no-cache add libxml2
    apk --no-cache add readline
    apk --no-cache add libxslt
    apk --no-cache add libffi
    apk --no-cache add nodejs
    apk --no-cache add tzdata
    apk --no-cache add shadow
    apk --no-cache add nodejs-npm
    apk --no-cache add libressl
    apk --no-cache add yarn
    apk --no-cache add libatomic
    apk --no-cache add ncurses-terminfo-base
    apk --no-cache add ncurses-terminfo
    apk --no-cache add ruby
    apk --no-cache add ruby-dev
    apk --no-cache add yaml
    apk --no-cache add ruby-io-console
    apk --no-cache add ruby-bundler
    apk --no-cache add ruby-irb
    apk --no-cache add ruby-json
    apk --no-cache add ruby-rake
    apk --no-cache add ruby-bigdecimal

    # ssh_config for gitlab
    printf "Host gitlab-prod.gitlab-prod\n\tStrictHostKeyChecking no\n\tUserKnownHostsFile=/dev/null\n" >> /etc/ssh/ssh_config

  setup: |
    # jekyll
    echo 'source "https://rubygems.org"' > /root/Gemfile
    echo 'gem "jekyll", "~> 4.2"' >> /root/Gemfile
    echo 'gem "webrick", "~> 1.7"' >> /root/Gemfile
    echo 'gem "jekyll-admin", group: :jekyll_plugins' >> /root/Gemfile
    cd /root && bundle install
    sed -i 's/"host"/"hostAdmin"/g' /usr/lib/ruby/gems/*/gems/jekyll-admin-*/lib/jekyll-admin/urlable.rb

    # install npm packages
    npm install -g commitizen cz-conventional-changelog cz-customizable

    # configure commitizen
    echo '{ "path": "cz-conventional-changelog" }' > /root/.czrc

    # configure ssh
    mkdir -p /root/.ssh
    chmod 700 /root/.ssh
    echo 'Host *' > /root/.ssh/config
    echo '    StrictHostKeyChecking no' >> /root/.ssh/config
    chmod 400 /root/.ssh/config
